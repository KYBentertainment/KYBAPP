<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KYB Seen - BL/GL Tracking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Space Grotesk', sans-serif;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #1f2937;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #10b981;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #059669;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
      50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0); opacity: 1; }
      100% { transform: scale(4); opacity: 0; }
    }
    
    @keyframes heroSlide {
      0% { opacity: 0; transform: translateX(100px); }
      100% { opacity: 1; transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    .slide-up {
      animation: slideUp 0.3s ease;
    }
    
    .slide-down {
      animation: slideDown 0.3s ease;
    }
    
    .pulse-glow {
      animation: pulseGlow 2s infinite;
    }
    
    .hero-slide {
      animation: heroSlide 0.8s ease-out;
    }
    
    .glassmorphism {
      background: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }
    
    .btn-gradient-bl-gl {
      background: linear-gradient(135deg, #10b981, #ec4899);
    }
    
    .btn-gradient-bl-gl:hover {
      opacity: 0.85;
    }
    
    .avatar-gradient {
      background: linear-gradient(135deg, #10b981, rgba(236, 72, 153, 0.8));
    }
    
    .genre-badge-bl {
      background: #ec4899;
      color: #ffffff;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .genre-badge-gl {
      background: #a855f7;
      color: #ffffff;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .ripple-effect {
      position: relative;
      overflow: hidden;
    }
    
    .ripple-effect::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      top: 50%;
      left: 50%;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
    }
    
    .ripple-effect:active::after {
      animation: ripple 0.6s ease-out;
    }
    
    .hero-banner {
      position: relative;
      width: 100%;
      height: 500px;
      overflow: hidden;
    }
    
    .hero-slide-item {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }
    
    .hero-slide-item.active {
      opacity: 1;
    }
    
    .hero-slide-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }
    
    .hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to right, rgba(17, 24, 39, 1) 30%, transparent 70%);
      z-index: 1;
    }
    
    .hero-content {
      position: absolute;
      left: 0;
      bottom: 0;
      padding: 3rem;
      z-index: 2;
      max-width: 600px;
    }
    
    .hero-dots {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 3;
      display: flex;
      gap: 8px;
    }
    
    .hero-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hero-dot.active {
      background: #10b981;
      width: 30px;
      border-radius: 5px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full w-full bg-gray-900 text-white overflow-x-hidden">
  <div id="app" class="h-full w-full"></div>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBcjjoLZ3XU3SD8xgT6XmvZEVrmoV34A4M",
      authDomain: "kyb-seen.firebaseapp.com",
      projectId: "kyb-seen",
      storageBucket: "kyb-seen.firebasestorage.app",
      messagingSenderId: "916013840344",
      appId: "1:916013840344:web:561274a6db9470a7ca64ad",
      measurementId: "G-1C8ZDYR1JS"
    };
    
    // Initialize Firebase
    let auth = null;
    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
    } catch (error) {
      console.log('Firebase initialization error:', error);
    }
    
    // Global state
    const state = {
      user: null,
      currentView: 'home',
      currentSeries: null,
      allRecords: [],
      isGuest: false,
      heroIndex: 0,
      heroInterval: null
    };
    
    // Sistema de datos directo con Firestore
    const dataSdk = {
      async create(record) {
        try {
          if (!db) {
            console.error('‚ùå Firestore NO inicializado');
            showToast('‚ö†Ô∏è Base de datos no lista. Ve a Firebase Console y activa Firestore.', 'error');
            return { isOk: false, isError: true, error: new Error('Firestore not initialized') };
          }
          
          if (!state.user) {
            console.error('‚ùå Usuario no autenticado');
            return { isOk: false, isError: true, error: new Error('User not authenticated') };
          }
          
          console.log('üîÑ Guardando...', record);
          showToast('‚è≥ Guardando...', 'info');
          
          const dataToSave = {
            ...record,
            user_profile: record.user_profile || state.user.uid,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          const docRef = await db.collection('kyb_data').add(dataToSave);
          
          console.log('‚úÖ ¬°GUARDADO! ID:', docRef.id);
          showToast('‚úÖ ¬°Guardado!', 'success');
          return { isOk: true, isError: false, data: docRef.id };
        } catch (error) {
          console.error('‚ùå ERROR:', error.code, error.message);
          
          if (error.code === 'permission-denied') {
            showToast('‚ùå Ve a Firebase ‚Üí Firestore ‚Üí Rules y permite escritura', 'error');
          } else if (error.code === 'unavailable') {
            showToast('‚ùå Firestore no est√° activado. Ve a Firebase Console.', 'error');
          } else {
            showToast('‚ùå Error: ' + error.message, 'error');
          }
          
          return { isOk: false, isError: true, error };
        }
      },
      
      async update(record) {
        try {
          if (!db) {
            console.error('‚ùå Firestore no disponible');
            showToast('‚ùå Error: Base de datos no conectada', 'error');
            return { isOk: false, isError: true, error: new Error('Database not available') };
          }
          
          if (!record.__backendId) {
            console.error('‚ùå Registro sin ID para actualizar');
            showToast('‚ùå Error: Registro inv√°lido', 'error');
            return { isOk: false, isError: true, error: new Error('Invalid record - missing ID') };
          }
          
          console.log('üîÑ Actualizando registro:', record.__backendId);
          
          // Remover campos que no deben actualizarse
          const { __backendId, created_at, ...updateData } = record;
          
          await db.collection('kyb_data').doc(__backendId).update({
            ...updateData,
            updated_at: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          console.log('‚úÖ ¬°Actualizado correctamente!');
          showToast('‚úÖ Cambios guardados', 'success');
          return { isOk: true, isError: false, data: null };
        } catch (error) {
          console.error('‚ùå Error al actualizar:', error);
          showToast('‚ùå Error: ' + error.message, 'error');
          return { isOk: false, isError: true, error };
        }
      },
      
      async delete(record) {
        try {
          if (!db) {
            console.error('‚ùå Firestore no disponible');
            showToast('‚ùå Error: Base de datos no conectada', 'error');
            return { isOk: false, isError: true, error: new Error('Database not available') };
          }
          
          if (!record.__backendId) {
            console.error('‚ùå Registro sin ID para eliminar');
            showToast('‚ùå Error: Registro inv√°lido', 'error');
            return { isOk: false, isError: true, error: new Error('Invalid record - missing ID') };
          }
          
          console.log('üîÑ Eliminando registro:', record.__backendId);
          
          await db.collection('kyb_data').doc(record.__backendId).delete();
          
          console.log('‚úÖ ¬°Eliminado correctamente!');
          showToast('‚úÖ Eliminado', 'success');
          return { isOk: true, isError: false, data: null };
        } catch (error) {
          console.error('‚ùå Error al eliminar:', error);
          showToast('‚ùå Error: ' + error.message, 'error');
          return { isOk: false, isError: true, error };
        }
      },
      
      async init() {
        try {
          if (!db) {
            console.error('‚ùå Firebase no disponible');
            showToast('‚ö†Ô∏è Modo sin conexi√≥n', 'error');
            return { isOk: false, isError: true, error: new Error('Database not available') };
          }
          
          console.log('üîÑ Conectando a Firestore...');
          
          // Escuchar cambios en tiempo real
          const unsubscribe = db.collection('kyb_data').onSnapshot(
            (snapshot) => {
              console.log('üì¶ Datos recibidos:', snapshot.size, 'registros');
              
              const records = [];
              snapshot.forEach((doc) => {
                records.push({
                  __backendId: doc.id,
                  ...doc.data()
                });
              });
              
              const previousCount = state.allRecords.length;
              state.allRecords = records;
              
              console.log('‚úÖ Estado actualizado:', records.length, 'registros totales');
              
              // Mostrar notificaci√≥n solo si hubo cambios
              if (previousCount !== records.length && previousCount > 0) {
                showToast('üîÑ Datos sincronizados', 'info');
              }
              
              // Actualizar vista actual sin recargar toda la p√°gina
              updateCurrentView();
            },
            (error) => {
              console.error('‚ùå Error de conexi√≥n:', error);
              showToast('‚ùå Error de conexi√≥n a la base de datos', 'error');
            }
          );
          
          console.log('‚úÖ Conectado a Firestore - Escuchando cambios en tiempo real');
          showToast('‚úÖ Conectado a la base de datos', 'success');
          return { isOk: true, isError: false, data: null };
        } catch (error) {
          console.error('‚ùå Error al inicializar:', error);
          showToast('‚ùå No se pudo conectar', 'error');
          return { isOk: false, isError: true, error };
        }
      }
    };
    
    // Funci√≥n para actualizar la vista actual
    function updateCurrentView() {
      if (state.currentView === 'home') {
        // No recargar home autom√°ticamente para evitar parpadeo
      } else if (state.currentView === 'series' && state.currentSeries) {
        renderSeriesDetail(state.currentSeries);
      } else if (state.currentView === 'polls') {
        renderPolls();
      } else if (state.currentView === 'profile') {
        renderProfile();
      }
    }
    
    console.log('üöÄ Sistema de datos configurado: FIRESTORE PURO');
    

    
    // Admin emails
    const ADMIN_EMAILS = ['soportedekyb@gmail.com', 'elihuf07@gmail.com'];
    
    // Series data with banners for hero rotation
    const SERIES_DATA = [
      { 
        id: 's1', 
        title: 'Bad Buddy', 
        genre: 'BL', 
        country: 'Thailand', 
        rating: 9.2, 
        votes: 1547, 
        year: 2021, 
        episodes: 12, 
        duration: '45min', 
        image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRSBw8r7l-Bci8IAfM3QeIdQEkFsHvdkC__9Q&s',
        banner: 'https://1.vikiplatform.com/c/39522c/acdd3434ed.jpg?x=b&a=0x0',
        synopsis: 'Pat y Pran, hijos de familias rivales, desarrollan una amistad secreta que se convierte en amor mientras navegan las expectativas familiares.',
        featured: true
      },
      { id: 's2', title: 'Semantic Error', genre: 'BL', country: 'Korea', rating: 9.0, votes: 1823, year: 2022, episodes: 8, duration: '25min', image: 'https://img.gagaoolala.com/media/6ed95210-844420-lg.jpg', banner: 'https://1.vikiplatform.com/c/38375c/f972f6b433.jpg?x=b', synopsis: 'Un estudiante de inform√°tica obsesionado con la l√≥gica conoce a un dise√±ador art√≠stico, desafiando su visi√≥n racional del mundo.', featured: true },
      { id: 's3', title: 'GAP The Series', genre: 'GL', country: 'Thailand', rating: 8.8, votes: 1234, year: 2022, episodes: 12, duration: '50min', image: 'https://image.tmdb.org/t/p/original/jF7kr8IotMYsbef1cVj6Mebvfi0.jpg', banner: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiEBRYiQ_SUfL2yMfUdbMNBopeXV4EAf41LVRyhEDGy1zU48apyTfo5G1KvdWmMRYQjCi4yLRrO0AoClklHyycqjHEudZ4olob85bIxMDYlfZWu2A8RHTS0XKnJCh7sOKRNjepDan0HKAOaKpfHT05b9irJ4DzZUps_ESjtxWk6vrOlq62pGMJr4Tdo/s16000/GAPTheSeries_2.jpg', synopsis: 'Sam, CEO de una empresa, se enamora de Mon, su nueva asistente, desafiando las normas sociales y corporativas.', featured: true },
      { id: 's4', title: 'Cherry Magic', genre: 'BL', country: 'Japan', rating: 8.9, votes: 2156, year: 2020, episodes: 12, duration: '24min', image: 'https://m.media-amazon.com/images/M/MV5BODhkNjA4ZGEtNDA3OC00NzE3LWE2NmYtMGVjNWFjZWMzYjZhXkEyXkFqcGc@._V1_FMjpg_UX1000_.jpg', synopsis: 'Adachi, un oficinista virgen de 30 a√±os, descubre que puede leer mentes y se entera de que su compa√±ero popular est√° enamorado de √©l.' },
      { id: 's5', title: 'We Best Love', genre: 'BL', country: 'Taiwan', rating: 8.7, votes: 1678, year: 2021, episodes: 12, duration: '30min', image: 'https://media.themoviedb.org/t/p/w500/ohPGg1QcvoytRxP57VO1jycuCaY.jpg', synopsis: 'Dos rivales de secundaria se reencuentran a√±os despu√©s, descubriendo que su competencia escond√≠a sentimientos m√°s profundos.' },
      { id: 's6', title: 'The Handmaiden', genre: 'GL', country: 'Korea', rating: 9.5, votes: 3421, year: 2016, episodes: 1, duration: '145min', image: 'https://s-media-cache-ak0.pinimg.com/736x/e0/b8/24/e0b824d4fd4b720524c67c8a0b4b6f9f--film-poster-movie-posters.jpg', synopsis: 'Una ladrona es contratada como sirvienta de una heredera japonesa, pero un plan de estafa se convierte en romance inesperado.' },
      { id: 's7', title: 'Gameboys', genre: 'BL', country: 'Philippines', rating: 8.6, votes: 1543, year: 2020, episodes: 13, duration: '15min', image: 'https://static.wikia.nocookie.net/drama/images/3/3c/Gameboys.jpg', synopsis: 'Durante la cuarentena, Cairo y Gavreel desarrollan una conexi√≥n virtual que se convierte en algo m√°s significativo.' },
      { id: 's8', title: 'Tsukutabe', genre: 'GL', country: 'Japan', rating: 8.4, votes: 876, year: 2020, episodes: 12, duration: '24min', image: 'https://i.mydramalist.com/x4m0ly_4f.jpg', synopsis: 'Nomoto disfruta cocinar para Kasuga, su vecina, y juntas descubren una conexi√≥n m√°s profunda a trav√©s de la comida.' },
      { id: 's9', title: 'KinnPorsche', genre: 'BL', country: 'Thailand', rating: 8.9, votes: 2987, year: 2022, episodes: 14, duration: '60min', image: 'https://image.tmdb.org/t/p/original/bIm559uuYuP0TVh02T2u7eCj18A.jpg', synopsis: 'Un estudiante se convierte en guardaespaldas de un heredero mafioso, desarrollando una relaci√≥n complicada en medio del peligro.' },
      { id: 's10', title: 'Love Class', genre: 'BL', country: 'Korea', rating: 7.8, votes: 1234, year: 2022, episodes: 6, duration: '25min', image: 'https://static.wikia.nocookie.net/drama/images/d/de/Love_Class-5.jpg', synopsis: 'Estudiantes universitarios exploran el amor y las relaciones en una clase sobre ese tema.' },
      { id: 's11', title: 'Old Fashion Cupcake', genre: 'BL', country: 'Japan', rating: 9.1, votes: 1876, year: 2022, episodes: 5, duration: '24min', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSbtFq-G6VfDKT0N5SuVa4PWuYNRvwlyq07vg&s', banner: 'https://1.vikiplatform.com/c/38580c/d1b8882fa1.jpg?x=b&a=0x0', synopsis: 'Un jefe de mediana edad y su subordinado m√°s joven descubren nuevas perspectivas sobre la vida y el amor.', featured: true },
      { id: 's12', title: 'Show Me Love', genre: 'GL', country: 'Thailand', rating: 8.2, votes: 765, year: 2023, episodes: 9, duration: '45min', image: 'https://media.themoviedb.org/t/p/w116_and_h174_face/8QULpSnASKFjjxrMjWM9J1C1WdJ.jpg', synopsis: 'Dos mujeres de diferentes mundos se encuentran y desaf√≠an las expectativas sobre el amor y la identidad.' },
      { id: 's13', title: 'History 3 MODC', genre: 'BL', country: 'Taiwan', rating: 8.8, votes: 1432, year: 2019, episodes: 20, duration: '30min', image: 'https://i.mydramalist.com/233m7f.jpg', synopsis: 'Un polic√≠a encubierto se infiltra en una banda y desarrolla sentimientos complicados por el l√≠der.' },
      { id: 's14', title: 'Lily Fever', genre: 'GL', country: 'Korea', rating: 8.0, votes: 654, year: 2015, episodes: 9, duration: '12min', image: 'https://m.media-amazon.com/images/M/MV5BNjRiYzYyMjItYTVmYS00ZTBhLWE2ODUtNTczMjExYzBiYjZhXkEyXkFqcGc@._V1_.jpg', synopsis: 'Una relaci√≥n entre dos mujeres se desarrolla con humor y ternura en esta serie web coreana.' },
      { id: 's15', title: 'My School President', genre: 'BL', country: 'Thailand', rating: 9.3, votes: 2543, year: 2023, episodes: 12, duration: '45min', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRlpVufSEi8suyH36MzFd0LwK0CiYrXs_ttYg&s', banner: 'https://media.themoviedb.org/t/p/w500/4GeVGlTSwK2DyW5oIGJcxc4c91f.jpg', synopsis: 'El l√≠der de una banda escolar se enamora del presidente estudiantil en esta dulce historia de primer amor.', featured: true },
      { id: 's16', title: 'My Beautiful Man', genre: 'BL', country: 'Japan', rating: 8.5, votes: 1765, year: 2021, episodes: 6, duration: '24min', image: 'https://i.mydramalist.com/dXv4z_4f.jpg', synopsis: 'Un estudiante t√≠mido desarrolla una obsesi√≥n por el chico popular de su clase, llevando a una relaci√≥n √∫nica.' },
      { id: 's17', title: '23.5', genre: 'GL', country: 'Thailand', rating: 8.6, votes: 987, year: 2024, episodes: 12, duration: '24min', image: 'https://1.vikiplatform.com/c/40918c/18c71662e4.jpg?x=b&s=480x270&e=t&q=g', synopsis: 'Una estudiante de primer a√±o se enamora de una guitarrista de √∫ltimo a√±o despu√©s de escuchar su m√∫sica.' },
      { id: 's18', title: 'TharnType', genre: 'BL', country: 'Thailand', rating: 8.3, votes: 2341, year: 2019, episodes: 12, duration: '45min', image: 'https://m.media-amazon.com/images/M/MV5BMTNiMGE1YjMtZDI3Zi00ZGEwLTg5OTctYjIzNzBmM2Q2ZDRjXkEyXkFqcGc@._V1_FMjpg_UX1000_.jpg', synopsis: 'Un estudiante homof√≥bico debe compartir habitaci√≥n con un chico gay, desafiando sus prejuicios y descubriendo el amor.' },
      { id: 's19', title: 'SOTUS', genre: 'BL', country: 'Thailand', rating: 8.5, votes: 3124, year: 2016, episodes: 15, duration: '45min', image: 'https://m.media-amazon.com/images/M/MV5BNzVlY2Y2ZTctOTk0Mi00NTMwLWI1YmQtYTY1MWFjMGQ2MzUzXkEyXkFqcGc@._V1_QL75_UX500_CR0,47,500,281_.jpg', synopsis: 'Arthit, l√≠der de estudiantes veteranos, usa el sistema de novatadas para entrenar a los nuevos, incluido Kongpob, quien desaf√≠a las reglas.' },
      { id: 's20', title: 'SOTUS S', genre: 'BL', country: 'Thailand', rating: 8.4, votes: 2876, year: 2017, episodes: 13, duration: '45min', image: 'https://i.mydramalist.com/kP1zb_4c.jpg', synopsis: 'Arthit y Kongpob enfrentan los desaf√≠os de mantener su relaci√≥n secreta mientras inician sus carreras profesionales.' },
      { id: 's21', title: '2gether', genre: 'BL', country: 'Thailand', rating: 8.7, votes: 4231, year: 2020, episodes: 13, duration: '45min', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTaBue8Dn5uEM9Wf9mV9wE43nWwJBuCg0gc-A&s', synopsis: 'Tine busca un novio falso para alejar a un admirador y Sarawat, el chico m√°s popular, acepta el papel.' },
      { id: 's22', title: 'We Are', genre: 'BL', country: 'Thailand', rating: 8.6, votes: 1987, year: 2024, episodes: 16, duration: '45min', image: 'https://1.vikiplatform.com/c/40679c/0c3686d1a2.jpg?x=b', synopsis: 'Un grupo de amigos universitarios navega el amor, la amistad y el crecimiento personal mientras descubren sus identidades.' },
      { id: 's23', title: 'Until We Meet Again', genre: 'BL', country: 'Thailand', rating: 9.0, votes: 3456, year: 2019, episodes: 17, duration: '50min', image: 'https://1.vikiplatform.com/c/38172c/28065bd69e.jpg?x=b&a=0x0&s=480x270&e=t&q=g', synopsis: 'Dos almas reencarnadas se encuentran en una nueva vida, conectadas por un amor tr√°gico del pasado que busca redenci√≥n.' },
      { id: 's24', title: 'Revenged Love', genre: 'BL', country: 'Thailand', rating: 8.4, votes: 1543, year: 2024, episodes: 12, duration: '45min', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQDWMXFrL5I9CkjSSMelMtJkeccgy6aNNXwkg&s', banner: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRZwIwfWY6x5UwdMeQ_LjRoLVLdHTi11CCiYA&s', synopsis: 'Una historia de venganza se convierte en romance cuando dos enemigos descubren que sus sentimientos van m√°s all√° del odio.' },
      { id: 's25', title: 'ABO Desire', genre: 'BL', country: 'Thailand', rating: 7.9, votes: 987, year: 2024, episodes: 8, duration: '30min', image: 'https://static.wikia.nocookie.net/drama/images/e/eb/ABO_Desire.jpg', banner: 'https://1.vikiplatform.com/c/41187c/59402231a4.jpg?x=b', synopsis: 'En un mundo donde existen alfas, betas y omegas, dos personas de diferentes castas desaf√≠an las normas sociales por amor.' },
      { id: 's26', title: 'The Untamed', genre: 'BL', country: 'China', rating: 9.5, votes: 5432, year: 2019, episodes: 50, duration: '45min', image: 'https://static.wikia.nocookie.net/drama/images/7/7e/The_Untamed-32.jpg', banner: 'https://occ-0-8407-90.1.nflxso.net/dnm/api/v6/6AYY37jfdO6hpXcMjf9Yu5cnmO0/AAAABS9nACVh6wamSrXsKVSf1L-Eh34P5D3CktlZAgmvx1ka-3gUOigN0SL17BhNE8fw67PI4zKBOV4EttEAOogJPcNgNdezWeJOf55Z.jpg?r=a07', synopsis: 'Wei Wuxian y Lan Wangji se embarcan en una aventura √©pica de cultivo, misterio y una conexi√≥n que trasciende el tiempo.', featured: true },
      { id: 's27', title: 'Word of Honor', genre: 'BL', country: 'China', rating: 9.3, votes: 4321, year: 2021, episodes: 36, duration: '45min', image: 'https://i.mydramalist.com/BL0bV_4c.jpg', banner: 'https://occ-0-8407-2218.1.nflxso.net/dnm/api/v6/6AYY37jfdO6hpXcMjf9Yu5cnmO0/AAAABWjT-wXtgixdt0eqJitDKCPnvWZH4ZEz5YtNo-ShWXMbRBKMR9vE0h-vxpyU2FilvJ7r4uMjawzqQuNaS2vcMyOSWXIOhBUmiM0L.jpg?r=128', synopsis: 'Un asesino retirado y un l√≠der de secta se unen para resolver un misterio mientras desarrollan una profunda amistad.', featured: true },
      { id: 's28', title: 'Only Friends', genre: 'BL', country: 'Thailand', rating: 8.6, votes: 2876, year: 2023, episodes: 12, duration: '45min', image: 'https://i.mydramalist.com/2BYBx_4c.jpg', banner: 'https://images.plex.tv/photo?size=large-1920&scale=1&url=https%3A%2F%2Fimage.tmdb.org%2Ft%2Fp%2Foriginal%2FlEvGrUKlQRKq5nf8eEYTEWv3a4O.jpg', synopsis: 'Un grupo de amigos universitarios navega relaciones complicadas, tri√°ngulos amorosos y secretos que ponen a prueba su amistad.', featured: true },
      { id: 's29', title: 'Love By Chance', genre: 'BL', country: 'Thailand', rating: 8.5, votes: 3124, year: 2018, episodes: 14, duration: '45min', image: 'https://static.wikia.nocookie.net/drama/images/a/ad/Love_By_Chance-3.jpg', banner: 'https://pic8.iqiyipic.com/image/20250403/62/8d/a_100494437_m_601_en_m2_284_160.webp', synopsis: 'Ae, un estudiante com√∫n, conoce a Pete, un chico rico y t√≠mido, comenzando una historia de amor que supera las diferencias sociales.' }
    ];
    
    // Avatar library by series
    const AVATAR_LIBRARY = [
      {
        series: 'Bad Buddy',
        characters: [
          { id: 'bb1', name: 'Pat (Ohm)', url: 'https://i.mydramalist.com/BP6qV_5f.jpg' },
          { id: 'bb2', name: 'Pran (Nanon)', url: 'https://i.mydramalist.com/b38JJZ_5c.jpg' },
          { id: 'bb3', name: 'Ink', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=I' },
          { id: 'bb4', name: 'Pa', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=PA' }
        ]
      },
      {
        series: 'Semantic Error',
        characters: [
          { id: 'se1', name: 'Sangwoo', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=SW' },
          { id: 'se2', name: 'Jaeyoung', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=JY' },
          { id: 'se3', name: 'Jiyeon', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=J' }
        ]
      },
      {
        series: 'GAP The Series',
        characters: [
          { id: 'gap1', name: 'Sam', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=S' },
          { id: 'gap2', name: 'Mon', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=M' },
          { id: 'gap3', name: 'Tee', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=T' },
          { id: 'gap4', name: 'Jim', url: 'https://via.placeholder.com/80/a855f7/ffffff?text=JM' }
        ]
      },
      {
        series: 'Cherry Magic',
        characters: [
          { id: 'cm1', name: 'Adachi', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=A' },
          { id: 'cm2', name: 'Kurosawa', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=K' },
          { id: 'cm3', name: 'Tsuge', url: 'https://via.placeholder.com/80/ec4899/ffffff?text=TS' }
        ]
      }
    ];
    
    // Hero carousel functions
    function startHeroCarousel() {
      const featuredSeries = SERIES_DATA.filter(s => s.featured);
      if (featuredSeries.length === 0) return;
      
      state.heroInterval = setInterval(() => {
        state.heroIndex = (state.heroIndex + 1) % featuredSeries.length;
        updateHeroSlide();
      }, 5000);
    }
    
    function stopHeroCarousel() {
      if (state.heroInterval) {
        clearInterval(state.heroInterval);
        state.heroInterval = null;
      }
    }
    
    function updateHeroSlide() {
      const slides = document.querySelectorAll('.hero-slide-item');
      const dots = document.querySelectorAll('.hero-dot');
      
      slides.forEach((slide, index) => {
        if (index === state.heroIndex) {
          slide.classList.add('active');
        } else {
          slide.classList.remove('active');
        }
      });
      
      dots.forEach((dot, index) => {
        if (index === state.heroIndex) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
    }
    
    // Toast notifications
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = `slide-down px-6 py-4 rounded-lg shadow-lg text-white font-semibold mb-3 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
      }`;
      toast.textContent = message;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toast-container';
      container.className = 'fixed top-4 right-4 z-50 flex flex-col items-end';
      container.style.width = '320px';
      document.body.appendChild(container);
      return container;
    }
    
    // Initialize app
    async function initializeApp() {
      try {
        // Initialize Firestore listener
        if (db) {
          await dataSdk.init();
          console.log('‚úÖ Sistema de persistencia listo');
        } else {
          console.warn('‚ö†Ô∏è Firebase no disponible - modo sin persistencia');
        }
      } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
      }
      
      if (auth) {
        auth.onAuthStateChanged((user) => {
          if (user) {
            state.user = user;
            state.isGuest = false;
            navigateTo('home');
          } else if (state.isGuest) {
            navigateTo('home');
          } else {
            navigateTo('login');
          }
        });
      } else {
        navigateTo('login');
      }
    }
    
    // Navigation
    function navigateTo(view, data = null) {
      stopHeroCarousel();
      state.currentView = view;
      state.currentSeries = data;
      
      switch(view) {
        case 'login':
          renderLogin();
          break;
        case 'register':
          renderRegister();
          break;
        case 'home':
          renderHome();
          break;
        case 'series':
          renderSeriesDetail(data);
          break;
        case 'polls':
          renderPolls();
          break;
        case 'profile':
          renderProfile();
          break;
      }
    }
    
    // Render login
    function renderLogin() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-6 fade-in">
          <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 slide-up">
            <div class="text-center mb-8">
              <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-green-500 to-pink-500 bg-clip-text text-transparent">KYB Seen</h1>
              <p class="text-gray-400 text-base">Descubre y rastrea tus series BL/GL favoritas</p>
            </div>
            
            <h2 id="login-title" class="text-2xl font-semibold mb-6">Bienvenido</h2>
            
            <form id="login-form" class="space-y-4">
              <div>
                <label for="email" class="block text-sm font-semibold mb-2">Email</label>
                <input type="email" id="email" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <div>
                <label for="password" class="block text-sm font-semibold mb-2">Contrase√±a</label>
                <input type="password" id="password" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <button type="submit" class="w-full btn-gradient-bl-gl text-white font-bold py-3 rounded-lg ripple-effect transition">
                Iniciar Sesi√≥n
              </button>
            </form>
            
            <div class="mt-6 space-y-3">
              <button id="register-btn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg ripple-effect transition">
                Crear Cuenta Nueva
              </button>
              
              <button id="guest-btn" class="w-full bg-transparent border-2 border-green-500 text-green-500 hover:bg-green-500 hover:text-white font-semibold py-3 rounded-lg ripple-effect transition">
                Continuar como Invitado
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!auth) {
          showToast('Autenticaci√≥n no disponible', 'error');
          return;
        }
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const btn = e.target.querySelector('button[type="submit"]');
        
        btn.disabled = true;
        btn.textContent = 'Iniciando...';
        
        try {
          await auth.signInWithEmailAndPassword(email, password);
          showToast('¬°Bienvenido de vuelta!', 'success');
        } catch (error) {
          showToast(error.message, 'error');
          btn.disabled = false;
          btn.textContent = 'Iniciar Sesi√≥n';
        }
      });
      
      document.getElementById('register-btn').addEventListener('click', () => {
        navigateTo('register');
      });
      
      document.getElementById('guest-btn').addEventListener('click', () => {
        state.isGuest = true;
        state.user = { uid: 'guest', email: 'guest@kyb.seen', displayName: 'Invitado' };
        navigateTo('home');
        showToast('Modo invitado activado', 'info');
      });
    }
    
    // Render register
    function renderRegister() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full w-full flex items-center justify-center p-6 fade-in">
          <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-8 slide-up">
            <button id="back-btn" class="mb-4 text-green-500 hover:text-green-400 flex items-center transition">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Volver
            </button>
            
            <h2 id="register-title" class="text-2xl font-semibold mb-6">Crear Cuenta</h2>
            
            <form id="register-form" class="space-y-4">
              <div>
                <label for="reg-email" class="block text-sm font-semibold mb-2">Email</label>
                <input type="email" id="reg-email" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <div>
                <label for="reg-password" class="block text-sm font-semibold mb-2">Contrase√±a (m√≠nimo 6 caracteres)</label>
                <input type="password" id="reg-password" required minlength="6" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <div>
                <label for="reg-username" class="block text-sm font-semibold mb-2">Nombre de usuario</label>
                <input type="text" id="reg-username" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
              </div>
              
              <button type="submit" class="w-full btn-gradient-bl-gl text-white font-bold py-3 rounded-lg ripple-effect transition">
                Registrarse
              </button>
            </form>
          </div>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => {
        navigateTo('login');
      });
      
      document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!auth) {
          showToast('Autenticaci√≥n no disponible', 'error');
          return;
        }
        
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const username = document.getElementById('reg-username').value;
        const btn = e.target.querySelector('button[type="submit"]');
        
        if (password.length < 6) {
          showToast('La contrase√±a debe tener al menos 6 caracteres', 'error');
          return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Registrando...';
        
        try {
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          await userCredential.user.updateProfile({ displayName: username });
          
          if (dataSdk && state.allRecords.length < 999) {
            const createResult = await dataSdk.create({
              user_profile: userCredential.user.uid,
              username: username,
              subname: '',
              avatar_series_id: '',
              avatar_character_id: '',
              avatar_url: '',
              email: email
            });
            
            if (createResult.isOk) {
              showToast('¬°Cuenta creada con √©xito!', 'success');
            } else {
              showToast('Cuenta creada, pero error al crear perfil', 'info');
            }
          } else {
            showToast('¬°Cuenta creada con √©xito!', 'success');
          }
        } catch (error) {
          showToast(error.message, 'error');
          btn.disabled = false;
          btn.textContent = 'Registrarse';
        }
      });
    }
    
    // Render home
    function renderHome() {
      const app = document.getElementById('app');
      
      const blSeries = SERIES_DATA.filter(s => s.genre === 'BL');
      const glSeries = SERIES_DATA.filter(s => s.genre === 'GL');
      const popular = [...SERIES_DATA].sort((a, b) => b.rating - a.rating).slice(0, 6);
      const featuredSeries = SERIES_DATA.filter(s => s.featured);
      
      const countrySections = {
        'Thailand': SERIES_DATA.filter(s => s.country === 'Thailand'),
        'Korea': SERIES_DATA.filter(s => s.country === 'Korea'),
        'Japan': SERIES_DATA.filter(s => s.country === 'Japan'),
        'Taiwan': SERIES_DATA.filter(s => s.country === 'Taiwan'),
        'Philippines': SERIES_DATA.filter(s => s.country === 'Philippines')
      };
      
      const userProfile = state.allRecords.find(r => r.user_profile === state.user?.uid);
      const avatarUrl = userProfile?.avatar_url || '';
      
      const pollsCount = state.allRecords.filter(r => r.poll_id).length;
      const seriesMonthCount = state.allRecords.filter(r => r.series_month_series_id).length;
      const hasPollsIndicator = pollsCount > 0 || seriesMonthCount > 0;
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <header class="sticky top-0 z-40 glassmorphism border-b border-gray-700">
            <div class="max-w-screen-xl mx-auto px-6 py-4">
              <div class="flex items-center justify-between mb-4">
                <h1 id="app-title" class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-green-500 to-pink-500 bg-clip-text text-transparent">KYB Seen</h1>
                
                <div class="flex items-center gap-4">
                  <!-- Search Button (Desktop) -->
                  <button id="search-btn" class="hidden md:flex bg-gray-700 hover:bg-gray-600 p-3 rounded-lg transition ripple-effect">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                  </button>
                  
                  <button id="polls-btn" class="hidden md:flex relative bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold transition ripple-effect">
                    üìä Polls
                    ${hasPollsIndicator ? '<span class="absolute -top-1 -right-1 w-3 h-3 bg-pink-500 rounded-full pulse-glow"></span>' : ''}
                  </button>
                  
                  <button id="profile-btn" class="hidden md:block w-10 h-10 rounded-full overflow-hidden border-2 border-green-500 hover:scale-110 transition ${avatarUrl ? '' : 'avatar-gradient'}">
                    ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-white font-bold\\'>U</div>'">` : '<div class="w-full h-full flex items-center justify-center text-white font-bold">U</div>'}
                  </button>
                </div>
              </div>
            </div>
          </header>
          
          <!-- Hero Carousel -->
          ${featuredSeries.length > 0 ? `
            <section class="hero-banner">
              ${featuredSeries.map((series, index) => `
                <div class="hero-slide-item ${index === 0 ? 'active' : ''}" data-index="${index}">
                  <img src="${series.banner}" alt="${series.title}" onerror="this.style.display='none'">
                  <div class="hero-overlay"></div>
                  <div class="hero-content hero-slide">
                    <div class="mb-4">
                      <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'} text-sm">${series.genre}</span>
                      <span class="text-sm text-gray-300 ml-2">${series.country} ‚Ä¢ ${series.year}</span>
                    </div>
                    <h2 class="text-4xl md:text-5xl font-bold mb-4">${series.title}</h2>
                    <p class="text-base md:text-lg text-gray-300 mb-6 line-clamp-3">${series.synopsis}</p>
                    <div class="flex gap-4">
                      <button class="hero-watch-btn bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-3 rounded-lg ripple-effect transition" data-series-id="${series.id}">
                        ‚ñ∂ Ver Ahora
                      </button>
                      <button class="hero-info-btn bg-gray-700 hover:bg-gray-600 text-white font-bold px-6 py-3 rounded-lg ripple-effect transition" data-series-id="${series.id}">
                        ‚Ñπ M√°s Info
                      </button>
                    </div>
                  </div>
                </div>
              `).join('')}
              
              <div class="hero-dots">
                ${featuredSeries.map((_, index) => `
                  <div class="hero-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>
                `).join('')}
              </div>
            </section>
          ` : ''}
          
          <!-- Main content -->
          <main class="max-w-screen-xl mx-auto px-6 py-8 pb-24 md:pb-8">
            <p id="welcome-message" class="text-lg text-gray-300 mb-8">Descubre y rastrea tus series BL/GL favoritas</p>
            
            <!-- Popular -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 id="popular-title" class="text-2xl md:text-3xl font-bold">Popular</h2>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 md:gap-6">
                ${popular.map(series => createSeriesCard(series)).join('')}
              </div>
            </section>
            
            <!-- BL Series -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 id="bl-section-title" class="text-2xl md:text-3xl font-bold">Series BL</h2>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 md:gap-6">
                ${blSeries.slice(0, 6).map(series => createSeriesCard(series)).join('')}
              </div>
            </section>
            
            <!-- GL Series -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 id="gl-section-title" class="text-2xl md:text-3xl font-bold">Series GL</h2>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 md:gap-6">
                ${glSeries.slice(0, 6).map(series => createSeriesCard(series)).join('')}
              </div>
            </section>
            
            <!-- By country -->
            ${Object.entries(countrySections).map(([country, series]) => `
              <section class="mb-12">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-2xl md:text-3xl font-bold">${country}</h2>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4 md:gap-6">
                  ${series.slice(0, 6).map(s => createSeriesCard(s)).join('')}
                </div>
              </section>
            `).join('')}
          </main>
          
          <!-- Mobile nav -->
          <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 z-40">
            <div class="flex items-center justify-around py-3">
              <button class="nav-btn flex flex-col items-center text-green-500 font-semibold">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                <span class="text-xs">Inicio</span>
              </button>
              
              <button id="mobile-search-btn" class="nav-btn flex flex-col items-center text-gray-400 hover:text-green-500 font-semibold transition">
                <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <span class="text-xs">Buscar</span>
              </button>
              
              <button id="mobile-polls-btn" class="nav-btn flex flex-col items-center text-gray-400 hover:text-green-500 font-semibold transition relative">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                </svg>
                <span class="text-xs">Polls</span>
                ${hasPollsIndicator ? '<span class="absolute top-0 right-2 w-2 h-2 bg-pink-500 rounded-full"></span>' : ''}
              </button>
              
              <button id="mobile-profile-btn" class="nav-btn flex flex-col items-center text-gray-400 hover:text-green-500 font-semibold transition">
                <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-xs">Perfil</span>
              </button>
            </div>
          </nav>
        </div>
      `;
      
      // Start hero carousel
      if (featuredSeries.length > 0) {
        startHeroCarousel();
        
        // Hero dots click
        document.querySelectorAll('.hero-dot').forEach(dot => {
          dot.addEventListener('click', () => {
            stopHeroCarousel();
            state.heroIndex = parseInt(dot.dataset.index);
            updateHeroSlide();
            startHeroCarousel();
          });
        });
        
        // Hero buttons
        document.querySelectorAll('.hero-watch-btn, .hero-info-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const seriesId = btn.dataset.seriesId;
            const series = SERIES_DATA.find(s => s.id === seriesId);
            if (series) navigateTo('series', series);
          });
        });
      }
      
      document.getElementById('polls-btn').addEventListener('click', () => navigateTo('polls'));
      document.getElementById('mobile-polls-btn').addEventListener('click', () => navigateTo('polls'));
      document.getElementById('profile-btn').addEventListener('click', () => navigateTo('profile'));
      document.getElementById('mobile-profile-btn').addEventListener('click', () => navigateTo('profile'));
      
      // Search modal functionality
      document.getElementById('search-btn').addEventListener('click', () => {
        showSearchModal();
      });
      
      document.getElementById('mobile-search-btn').addEventListener('click', () => {
        showSearchModal();
      });
      
      function showSearchModal() {
        const modal = document.createElement('div');
        modal.id = 'search-modal';
        modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-lg z-50 flex items-start justify-center p-4 md:p-6 fade-in overflow-y-auto';
        modal.innerHTML = `
          <div class="w-full max-w-4xl mt-4 md:mt-20 slide-down">
            <!-- Search Input -->
            <div class="bg-gray-800 rounded-2xl shadow-2xl mb-4">
              <div class="p-4 md:p-6 border-b border-gray-700 flex items-center gap-3">
                <svg class="w-6 h-6 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input 
                  type="text" 
                  id="modal-search-input" 
                  placeholder="Buscar series por t√≠tulo, pa√≠s o g√©nero..." 
                  class="flex-1 bg-transparent text-white text-lg md:text-xl focus:outline-none"
                  autofocus
                >
                <button id="close-search-modal" class="text-gray-400 hover:text-white transition flex-shrink-0">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Results Container -->
            <div id="modal-search-results" class="hidden bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
              <div class="grid md:grid-cols-[2fr_1fr]">
                <!-- Main Results -->
                <div class="p-4 md:p-6 max-h-[60vh] overflow-y-auto border-r border-gray-700">
                  <h3 class="text-xs md:text-sm font-bold text-gray-400 mb-4">RESULTADOS</h3>
                  <div id="modal-main-results-content"></div>
                </div>
                
                <!-- Suggestions Sidebar (Desktop only) -->
                <div class="p-4 md:p-6 max-h-[60vh] overflow-y-auto hidden md:block">
                  <h3 class="text-sm font-bold text-gray-400 mb-4">SUGERENCIAS</h3>
                  <div id="modal-suggestions-content"></div>
                </div>
              </div>
            </div>
            
            <!-- Empty State -->
            <div id="modal-empty-state" class="bg-gray-800 rounded-2xl shadow-2xl p-8 md:p-12 text-center">
              <svg class="w-16 h-16 md:w-20 md:h-20 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <h3 class="text-xl md:text-2xl font-bold text-gray-400 mb-2">Busca tu serie favorita</h3>
              <p class="text-sm md:text-base text-gray-500">Escribe el t√≠tulo, pa√≠s o g√©nero para comenzar</p>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        const searchInput = document.getElementById('modal-search-input');
        const searchResults = document.getElementById('modal-search-results');
        const emptyState = document.getElementById('modal-empty-state');
        const mainResultsContent = document.getElementById('modal-main-results-content');
        const suggestionsContent = document.getElementById('modal-suggestions-content');
        
        // Focus input
        setTimeout(() => searchInput.focus(), 100);
        
        let searchTimeout;
        
        searchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          const query = e.target.value.trim().toLowerCase();
          
          if (!query) {
            searchResults.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
          }
          
          searchTimeout = setTimeout(() => {
            performModalSearch(query);
          }, 300);
        });
        
        function performModalSearch(query) {
          const results = SERIES_DATA.filter(series => 
            series.title.toLowerCase().includes(query) ||
            series.country.toLowerCase().includes(query) ||
            series.genre.toLowerCase().includes(query) ||
            series.synopsis.toLowerCase().includes(query)
          );
          
          if (results.length === 0) {
            mainResultsContent.innerHTML = '<p class="text-gray-400 text-sm text-center py-8">No se encontraron resultados</p>';
            suggestionsContent.innerHTML = '';
            searchResults.classList.remove('hidden');
            emptyState.classList.add('hidden');
            return;
          }
          
          // Display main results
          mainResultsContent.innerHTML = results.map(series => `
            <div class="modal-search-result-card flex gap-3 md:gap-4 bg-gray-700 hover:bg-gray-600 rounded-lg p-3 mb-3 cursor-pointer transition" data-series-id="${series.id}">
              <div class="w-16 h-24 md:w-24 md:h-36 flex-shrink-0 rounded-lg overflow-hidden bg-gray-600">
                <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'">
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-bold text-sm md:text-base mb-1 line-clamp-1 md:line-clamp-2">${series.title}</h4>
                <div class="flex items-center gap-2 mb-2">
                  <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'} text-xs">${series.genre}</span>
                  <span class="text-xs text-gray-400">${series.country} ‚Ä¢ ${series.year}</span>
                </div>
                <p class="text-xs md:text-sm text-gray-300 line-clamp-2 mb-2 hidden md:block">${series.synopsis}</p>
                <div class="flex items-center gap-1">
                  <svg class="w-3 h-3 md:w-4 md:h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-xs md:text-sm text-gray-400">${series.rating}/10</span>
                </div>
              </div>
            </div>
          `).join('');
          
          // Get suggestions
          const mainResult = results[0];
          const suggestions = SERIES_DATA
            .filter(s => 
              s.id !== mainResult.id && 
              (s.genre === mainResult.genre || s.country === mainResult.country)
            )
            .slice(0, 5);
          
          // Display suggestions
          suggestionsContent.innerHTML = suggestions.map(series => `
            <div class="modal-suggestion-card flex gap-3 bg-gray-700 hover:bg-gray-600 rounded-lg p-2 mb-2 cursor-pointer transition" data-series-id="${series.id}">
              <div class="w-12 h-18 flex-shrink-0 rounded overflow-hidden bg-gray-600">
                <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'">
              </div>
              <div class="flex-1 min-w-0">
                <h5 class="font-semibold text-sm mb-1 line-clamp-2">${series.title}</h5>
                <div class="flex items-center gap-1 mb-1">
                  <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'} text-xs py-0 px-2">${series.genre}</span>
                </div>
                <div class="flex items-center gap-1">
                  <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-xs text-gray-400">${series.rating}</span>
                </div>
              </div>
            </div>
          `).join('');
          
          searchResults.classList.remove('hidden');
          emptyState.classList.add('hidden');
          
          // Add click handlers
          document.querySelectorAll('.modal-search-result-card, .modal-suggestion-card').forEach(card => {
            card.addEventListener('click', () => {
              const seriesId = card.dataset.seriesId;
              const series = SERIES_DATA.find(s => s.id === seriesId);
              if (series) {
                modal.remove();
                navigateTo('series', series);
              }
            });
          });
        }
        
        // Close modal handlers
        document.getElementById('close-search-modal').addEventListener('click', () => {
          modal.remove();
        });
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
        
        // ESC key to close
        const escHandler = (e) => {
          if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
          }
        };
        document.addEventListener('keydown', escHandler);
      }
      
      document.querySelectorAll('.series-card').forEach(card => {
        card.addEventListener('click', () => {
          const seriesId = card.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
      
      document.querySelectorAll('.related-series-card').forEach(card => {
        card.addEventListener('click', () => {
          const seriesId = card.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
    }
    
    function createSeriesCard(series) {
      const userRating = state.allRecords.find(r => r.rating_series_id === series.id && r.user_profile === state.user?.uid);
      const userRatingValue = userRating ? userRating.rating_value : 0;
      
      return `
        <div class="series-card card-hover bg-gray-800 rounded-xl overflow-hidden cursor-pointer" data-series-id="${series.id}">
          <div class="aspect-[2/3] bg-gray-700">
            <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'">
          </div>
          <div class="p-4">
            <h3 class="font-bold text-base mb-2 line-clamp-2">${series.title}</h3>
            <div class="flex items-center justify-between mb-2">
              <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'}">${series.genre}</span>
              <span class="text-sm text-gray-400">${series.country}</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="flex items-center gap-1">
                ${renderStars(userRatingValue || series.rating)}
              </div>
              <span class="text-sm text-gray-400">${series.rating}</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderStars(rating, size = 'w-4 h-4') {
      const fullStars = Math.floor(rating / 2);
      const hasHalfStar = rating % 2 >= 1;
      let stars = '';
      
      for (let i = 0; i < fullStars; i++) {
        stars += `<svg class="${size} text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
      }
      
      if (hasHalfStar) {
        stars += `<svg class="${size} text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" opacity="0.5"></path></svg>`;
      }
      
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) {
        stars += `<svg class="${size} text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
      }
      
      return stars;
    }
    
    // Render series detail
    function renderSeriesDetail(series) {
      const app = document.getElementById('app');
      const gradient = series.genre === 'BL' ? 'from-pink-500/20' : 'from-purple-500/20';
      
      const userRating = state.allRecords.find(r => r.rating_series_id === series.id && r.user_profile === state.user?.uid);
      const allRatings = state.allRecords.filter(r => r.rating_series_id === series.id && r.rating_value);
      const avgRating = allRatings.length > 0 ? (allRatings.reduce((sum, r) => sum + r.rating_value, 0) / allRatings.length).toFixed(1) : series.rating;
      const totalVotes = allRatings.length || series.votes;
      
      const inMyList = state.allRecords.some(r => r.my_list_series_id === series.id && r.user_profile === state.user?.uid);
      
      const messages = state.allRecords
        .filter(r => r.message_series_id === series.id)
        .sort((a, b) => a.message_timestamp - b.message_timestamp)
        .map(msg => {
          const profile = state.allRecords.find(p => p.user_profile === msg.user_profile && p.username);
          return {
            ...msg,
            username: profile?.username || 'Usuario',
            subname: profile?.subname || '',
            avatar: profile?.avatar_url || ''
          };
        });
      
      const episodeRecords = state.allRecords.filter(r => r.episode_series_id === series.id && r.user_profile === state.user?.uid);
      const watchedCount = episodeRecords.filter(r => r.watched).length;
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <div class="relative h-64 md:h-80 bg-gradient-to-b ${gradient} to-gray-900">
            <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
            <img src="${series.banner || series.image}" alt="${series.title}" class="w-full h-full object-cover opacity-40" onerror="this.style.display='none'">
            
            <button id="back-btn" class="absolute top-4 left-4 bg-gray-900/80 backdrop-blur-sm p-3 rounded-full hover:bg-gray-800 transition">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            
            <div class="absolute bottom-0 left-0 right-0 p-6">
              <h1 class="text-4xl md:text-5xl font-bold mb-2">${series.title}</h1>
              <div class="flex items-center gap-3 flex-wrap">
                <span class="${series.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'}">${series.genre}</span>
                <span class="text-sm text-gray-300">${series.country} ‚Ä¢ ${series.year}</span>
                <span class="text-sm text-gray-300">${series.episodes} eps ‚Ä¢ ${series.duration}</span>
              </div>
            </div>
          </div>
          
          <!-- Content -->
          <div class="max-w-screen-xl mx-auto px-6 py-8 grid md:grid-cols-[1fr_300px] gap-8">
            <!-- Main content -->
            <div>
              <!-- Synopsis -->
              <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Sinopsis</h2>
                <p class="text-gray-300 text-base leading-relaxed">${series.synopsis}</p>
              </section>
              
              <!-- My List button -->
              <button id="my-list-btn" class="mb-8 ${inMyList ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} text-white font-bold px-6 py-3 rounded-lg ripple-effect transition ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}">
                ${inMyList ? '‚úì En Mi Lista' : '+ Agregar a Mi Lista'}
              </button>
              
              <!-- Related Series -->
              <section class="mb-8">
                <h2 class="text-2xl font-bold mb-4">Contenido Relacionado</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  ${(() => {
                    const related = SERIES_DATA
                      .filter(s => s.id !== series.id && (s.genre === series.genre || s.country === series.country))
                      .slice(0, 8);
                    
                    return related.map(s => `
                      <div class="related-series-card card-hover bg-gray-800 rounded-xl overflow-hidden cursor-pointer" data-series-id="${s.id}">
                        <div class="aspect-[2/3] bg-gray-700">
                          <img src="${s.image}" alt="${s.title}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                        </div>
                        <div class="p-3">
                          <h3 class="font-bold text-sm mb-1 line-clamp-2">${s.title}</h3>
                          <div class="flex items-center justify-between">
                            <span class="${s.genre === 'BL' ? 'genre-badge-bl' : 'genre-badge-gl'} text-xs">${s.genre}</span>
                            <div class="flex items-center gap-1">
                              <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                              </svg>
                              <span class="text-xs text-gray-400">${s.rating}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    `).join('');
                  })()}
                </div>
              </section>
              
              <!-- Rating -->
              <section class="mb-8 bg-gray-800 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Calificaci√≥n</h2>
                <div class="flex items-center gap-6 mb-4">
                  <div class="text-center">
                    <div class="text-4xl font-bold text-green-500">${avgRating}</div>
                    <div class="text-sm text-gray-400">${totalVotes} votos</div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-1 mb-2">
                      ${renderStars(avgRating * 2, 'w-6 h-6')}
                    </div>
                    <div class="text-sm text-gray-400">Promedio: ${avgRating}/10</div>
                  </div>
                </div>
                
                ${state.isGuest ? '<p class="text-gray-400 text-sm">Inicia sesi√≥n para calificar</p>' : `
                  <div>
                    <p class="text-sm font-semibold mb-3">Tu calificaci√≥n: ${userRating ? userRating.rating_value + '/10' : 'Sin calificar'}</p>
                    <div class="flex gap-2 flex-wrap" id="rating-buttons">
                      ${[1,2,3,4,5,6,7,8,9,10].map(num => `
                        <button class="rating-btn ${userRating?.rating_value === num ? 'bg-green-500' : 'bg-gray-700 hover:bg-gray-600'} text-white font-bold w-10 h-10 rounded-lg ripple-effect transition" data-rating="${num}">
                          ${num}
                        </button>
                      `).join('')}
                    </div>
                  </div>
                `}
              </section>
              
              <!-- Chat -->
              <section class="bg-gray-800 rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4">Chat Comunitario</h2>
                
                ${state.isGuest ? '<p class="text-gray-400 text-sm mb-4">Inicia sesi√≥n para participar en el chat</p>' : ''}
                
                <div id="chat-messages" class="space-y-4 mb-4 max-h-96 overflow-y-auto">
                  ${messages.length === 0 ? '<p class="text-gray-400 text-sm text-center py-8">No hay mensajes a√∫n. ¬°S√© el primero en comentar!</p>' : messages.map(msg => `
                    <div class="flex gap-3 slide-up">
                      <div class="w-10 h-10 rounded-full flex-shrink-0 overflow-hidden ${msg.avatar ? '' : 'avatar-gradient'}">
                        ${msg.avatar ? `<img src="${msg.avatar}" alt="${msg.username}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-white font-bold\\'>${msg.username[0].toUpperCase()}</div>'">` : `<div class="w-full h-full flex items-center justify-center text-white font-bold">${msg.username[0].toUpperCase()}</div>`}
                      </div>
                      <div class="flex-1">
                        <div class="mb-1">
                          <div class="font-bold text-sm">${msg.username}</div>
                          ${msg.subname ? `<div class="text-xs text-gray-400">@${msg.subname}</div>` : ''}
                        </div>
                        <p class="text-gray-300 text-sm">${msg.message_text}</p>
                      </div>
                    </div>
                  `).join('')}
                </div>
                
                ${!state.isGuest ? `
                  <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" required>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-2 rounded-lg ripple-effect transition">
                      Enviar
                    </button>
                  </form>
                ` : ''}
              </section>
            </div>
            
            <!-- Sidebar -->
            <div>
              <div class="bg-gray-800 rounded-xl p-6 sticky top-4">
                <h3 class="text-xl font-bold mb-4">Episodios (${watchedCount}/${series.episodes})</h3>
                <div class="space-y-2 max-h-96 overflow-y-auto">
                  ${Array.from({length: series.episodes}, (_, i) => {
                    const epNum = i + 1;
                    const watched = episodeRecords.some(r => r.episode_number === epNum && r.watched);
                    return `
                      <button class="episode-btn w-full flex items-center justify-between bg-gray-700 hover:bg-gray-600 p-3 rounded-lg transition ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}" data-episode="${epNum}">
                        <span class="font-semibold">Episodio ${epNum}</span>
                        <svg class="w-5 h-5 ${watched ? 'text-green-500' : 'text-gray-500'}" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                        </svg>
                      </button>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => navigateTo('home'));
      
      document.getElementById('my-list-btn')?.addEventListener('click', async () => {
        if (state.isGuest) {
          showToast('Inicia sesi√≥n para usar Mi Lista', 'info');
          return;
        }
        
        if (!dataSdk || !db) {
          showToast('Base de datos no disponible', 'error');
          return;
        }
        
        const btn = document.getElementById('my-list-btn');
        btn.disabled = true;
        
        if (inMyList) {
          const record = state.allRecords.find(r => r.my_list_series_id === series.id && r.user_profile === state.user.uid);
          if (record) {
            const result = await dataSdk.delete(record);
            if (result.isOk) {
              showToast('Eliminado de Mi Lista', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
            }
          }
        } else {
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            btn.disabled = false;
            return;
          }
          
          const result = await dataSdk.create({
            my_list_series_id: series.id,
            user_profile: state.user.uid
          });
          
          if (result.isOk) {
            showToast('Agregado a Mi Lista', 'success');
          } else {
            showToast('Error al agregar', 'error');
            btn.disabled = false;
          }
        }
      });
      
      document.querySelectorAll('.rating-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (state.isGuest) return;
          
          if (!dataSdk || !db) {
            showToast('Base de datos no disponible', 'error');
            return;
          }
          
          const rating = parseInt(btn.dataset.rating);
          btn.disabled = true;
          
          const existingRating = state.allRecords.find(r => r.rating_series_id === series.id && r.user_profile === state.user.uid);
          
          if (existingRating) {
            existingRating.rating_value = rating;
            const result = await dataSdk.update(existingRating);
            if (result.isOk) {
              showToast(`Calificaci√≥n actualizada: ${rating}/10`, 'success');
            } else {
              showToast('Error al actualizar', 'error');
              btn.disabled = false;
            }
          } else {
            if (state.allRecords.length >= 999) {
              showToast('L√≠mite de 999 registros alcanzado', 'error');
              btn.disabled = false;
              return;
            }
            
            const result = await dataSdk.create({
              rating_series_id: series.id,
              rating_value: rating,
              user_profile: state.user.uid
            });
            
            if (result.isOk) {
              showToast(`Calificado: ${rating}/10`, 'success');
            } else {
              showToast('Error al calificar', 'error');
              btn.disabled = false;
            }
          }
        });
      });
      
      document.getElementById('chat-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!dataSdk || !db) {
          showToast('Base de datos no disponible', 'error');
          return;
        }
        
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message || state.isGuest) return;
        
        if (state.allRecords.length >= 999) {
          showToast('L√≠mite de 999 registros alcanzado', 'error');
          return;
        }
        
        const btn = e.target.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'Enviando...';
        
        const result = await dataSdk.create({
          message_series_id: series.id,
          message_text: message,
          message_timestamp: Date.now(),
          user_profile: state.user.uid
        });
        
        if (result.isOk) {
          input.value = '';
          showToast('Mensaje enviado', 'success');
        } else {
          showToast('Error al enviar mensaje', 'error');
        }
        
        btn.disabled = false;
        btn.textContent = 'Enviar';
      });
      
      document.querySelectorAll('.episode-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (state.isGuest) {
            showToast('Inicia sesi√≥n para marcar episodios', 'info');
            return;
          }
          
          if (!dataSdk || !db) {
            showToast('Base de datos no disponible', 'error');
            return;
          }
          
          const epNum = parseInt(btn.dataset.episode);
          btn.disabled = true;
          
          const existingEpisode = state.allRecords.find(r => 
            r.episode_series_id === series.id && 
            r.episode_number === epNum && 
            r.user_profile === state.user.uid
          );
          
          if (existingEpisode) {
            existingEpisode.watched = !existingEpisode.watched;
            const result = await dataSdk.update(existingEpisode);
            if (!result.isOk) {
              showToast('Error al actualizar', 'error');
              btn.disabled = false;
            }
          } else {
            if (state.allRecords.length >= 999) {
              showToast('L√≠mite de 999 registros alcanzado', 'error');
              btn.disabled = false;
              return;
            }
            
            const result = await dataSdk.create({
              episode_series_id: series.id,
              episode_number: epNum,
              watched: true,
              user_profile: state.user.uid
            });
            
            if (!result.isOk) {
              showToast('Error al marcar episodio', 'error');
              btn.disabled = false;
            }
          }
        });
      });
      
      setTimeout(() => {
        const chatDiv = document.getElementById('chat-messages');
        if (chatDiv) chatDiv.scrollTop = chatDiv.scrollHeight;
      }, 100);
    }
    
    // Render polls
    function renderPolls() {
      const app = document.getElementById('app');
      const isAdmin = ADMIN_EMAILS.includes(state.user?.email || '');
      
      const seriesOfMonth = state.allRecords.filter(r => r.series_month_series_id);
      const polls = state.allRecords.filter(r => r.poll_id);
      const userVotes = state.allRecords.filter(r => r.poll_vote_poll_id && r.user_profile === state.user?.uid);
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <header class="sticky top-0 z-40 glassmorphism border-b border-gray-700">
            <div class="max-w-screen-xl mx-auto px-6 py-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <button id="back-btn" class="text-green-500 hover:text-green-400 transition">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h1 class="text-2xl md:text-3xl font-bold">Polls & Votaciones</h1>
              </div>
            </div>
          </header>
          
          <main class="max-w-screen-xl mx-auto px-6 py-8">
            <!-- Series del Mes -->
            <section class="mb-12">
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Serie del Mes</h2>
                ${isAdmin && seriesOfMonth.length < 2 ? `
                  <button id="add-series-month-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                    + Agregar Serie
                  </button>
                ` : ''}
              </div>
              
              ${seriesOfMonth.length === 0 ? '<p class="text-gray-400">No hay series del mes seleccionadas</p>' : ''}
              
              <div class="grid md:grid-cols-2 gap-6">
                ${seriesOfMonth.map(sm => {
                  const series = SERIES_DATA.find(s => s.id === sm.series_month_series_id);
                  if (!series) return '';
                  return `
                    <div class="bg-gray-800 rounded-xl overflow-hidden card-hover">
                      <div class="aspect-video bg-gray-700">
                        <img src="${series.banner || series.image}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                      </div>
                      <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">${series.title}</h3>
                        <p class="text-gray-400 text-sm mb-4">${series.synopsis.slice(0, 120)}...</p>
                        <div class="flex items-center justify-between">
                          <button class="view-series-btn bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition" data-series-id="${series.id}">
                            Ver Serie
                          </button>
                          ${isAdmin ? `
                            <button class="delete-series-month-btn text-red-500 hover:text-red-400 font-bold transition" data-record-id="${sm.__backendId}">
                              Eliminar
                            </button>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </section>
            
            <!-- Encuestas -->
            <section>
              <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Encuestas</h2>
                ${isAdmin ? `
                  <button id="add-poll-btn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                    + Crear Encuesta
                  </button>
                ` : ''}
              </div>
              
              ${polls.length === 0 ? '<p class="text-gray-400">No hay encuestas activas</p>' : ''}
              
              <div class="space-y-6">
                ${polls.map(poll => {
                  const options = JSON.parse(poll.poll_options || '[]');
                  const pollVotes = state.allRecords.filter(r => r.poll_vote_poll_id === poll.poll_id);
                  const userVote = userVotes.find(v => v.poll_vote_poll_id === poll.poll_id);
                  const hasVoted = !!userVote;
                  const totalVotes = pollVotes.length;
                  
                  return `
                    <div class="bg-gray-800 rounded-xl p-6">
                      <div class="flex items-start justify-between mb-4">
                        <h3 class="text-xl font-bold">${poll.poll_title}</h3>
                        ${isAdmin ? `
                          <button class="delete-poll-btn text-red-500 hover:text-red-400 font-bold transition" data-record-id="${poll.__backendId}">
                            Eliminar
                          </button>
                        ` : ''}
                      </div>
                      
                      <div class="space-y-3">
                        ${options.map((option, idx) => {
                          const optionVotes = pollVotes.filter(v => v.poll_vote_option === option).length;
                          const percentage = totalVotes > 0 ? Math.round((optionVotes / totalVotes) * 100) : 0;
                          const isSelected = userVote?.poll_vote_option === option;
                          
                          return `
                            <button class="poll-option-btn w-full relative overflow-hidden bg-gray-700 hover:bg-gray-600 rounded-lg p-4 transition ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''} ${isSelected ? 'ring-2 ring-green-500' : ''}" data-poll-id="${poll.poll_id}" data-option="${option}" ${hasVoted || state.isGuest ? 'disabled' : ''}>
                              ${hasVoted ? `
                                <div class="absolute inset-0 bg-green-500/20" style="width: ${percentage}%; transition: width 0.3s ease;"></div>
                              ` : ''}
                              <div class="relative flex items-center justify-between">
                                <span class="font-semibold">${option}</span>
                                ${hasVoted ? `<span class="text-sm font-bold">${percentage}%</span>` : ''}
                              </div>
                            </button>
                          `;
                        }).join('')}
                      </div>
                      
                      <div class="mt-4 text-sm text-gray-400">
                        ${totalVotes} voto${totalVotes !== 1 ? 's' : ''} total${totalVotes !== 1 ? 'es' : ''}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>
            </section>
          </main>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => navigateTo('home'));
      
      document.getElementById('add-series-month-btn')?.addEventListener('click', () => {
        showSeriesSelector('month');
      });
      
      document.getElementById('add-poll-btn')?.addEventListener('click', () => {
        showPollCreator();
      });
      
      document.querySelectorAll('.delete-series-month-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const recordId = btn.dataset.recordId;
          const record = state.allRecords.find(r => r.__backendId === recordId);
          
          if (record) {
            btn.disabled = true;
            btn.textContent = 'Eliminando...';
            
            const result = await dataSdk.delete(record);
            if (result.isOk) {
              showToast('Serie eliminada', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
              btn.textContent = 'Eliminar';
            }
          }
        });
      });
      
      document.querySelectorAll('.delete-poll-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const recordId = btn.dataset.recordId;
          const record = state.allRecords.find(r => r.__backendId === recordId);
          
          if (record) {
            btn.disabled = true;
            btn.textContent = 'Eliminando...';
            
            const result = await dataSdk.delete(record);
            if (result.isOk) {
              showToast('Encuesta eliminada', 'success');
            } else {
              showToast('Error al eliminar', 'error');
              btn.disabled = false;
              btn.textContent = 'Eliminar';
            }
          }
        });
      });
      
      document.querySelectorAll('.view-series-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const seriesId = btn.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
      
      document.querySelectorAll('.poll-option-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (state.isGuest) {
            showToast('Inicia sesi√≥n para votar', 'info');
            return;
          }
          
          const pollId = btn.dataset.pollId;
          const option = btn.dataset.option;
          
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            return;
          }
          
          btn.disabled = true;
          
          const result = await dataSdk.create({
            poll_vote_poll_id: pollId,
            poll_vote_option: option,
            user_profile: state.user.uid
          });
          
          if (result.isOk) {
            showToast('Voto registrado', 'success');
          } else {
            showToast('Error al votar', 'error');
            btn.disabled = false;
          }
        });
      });
    }
    
    function showSeriesSelector(type) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-in';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-auto slide-up">
          <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Seleccionar Serie</h3>
            <button class="close-modal text-gray-400 hover:text-white transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="p-6">
            <div class="grid grid-cols-2 gap-4">
              ${SERIES_DATA.map(series => `
                <button class="series-select-btn bg-gray-700 hover:bg-gray-600 rounded-lg p-4 transition text-left" data-series-id="${series.id}">
                  <div class="aspect-[2/3] bg-gray-600 rounded-lg mb-3 overflow-hidden">
                    <img src="${series.image}" alt="${series.title}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                  </div>
                  <h4 class="font-bold text-sm mb-1">${series.title}</h4>
                  <p class="text-xs text-gray-400">${series.genre} ‚Ä¢ ${series.country}</p>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      modal.querySelectorAll('.series-select-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const seriesId = btn.dataset.seriesId;
          
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            return;
          }
          
          btn.disabled = true;
          
          const result = await dataSdk.create({
            series_month_series_id: seriesId,
            series_month_created_by: state.user.uid
          });
          
          if (result.isOk) {
            showToast('Serie agregada', 'success');
            modal.remove();
          } else {
            showToast('Error al agregar serie', 'error');
            btn.disabled = false;
          }
        });
      });
    }
    
    function showPollCreator() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-in';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full slide-up">
          <div class="border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Crear Encuesta</h3>
            <button class="close-modal text-gray-400 hover:text-white transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="poll-creator-form" class="p-6 space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2">T√≠tulo de la Encuesta</label>
              <input type="text" id="poll-title" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition">
            </div>
            
            <div>
              <label class="block text-sm font-semibold mb-2">Opciones (2-4)</label>
              <input type="text" id="poll-option-1" placeholder="Opci√≥n 1" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition mb-2">
              <input type="text" id="poll-option-2" placeholder="Opci√≥n 2" required class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition mb-2">
              <input type="text" id="poll-option-3" placeholder="Opci√≥n 3 (opcional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition mb-2">
              <input type="text" id="poll-option-4" placeholder="Opci√≥n 4 (opcional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition">
            </div>
            
            <button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-lg ripple-effect transition">
              Crear Encuesta
            </button>
          </form>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      modal.querySelector('#poll-creator-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('poll-title').value.trim();
        const option1 = document.getElementById('poll-option-1').value.trim();
        const option2 = document.getElementById('poll-option-2').value.trim();
        const option3 = document.getElementById('poll-option-3').value.trim();
        const option4 = document.getElementById('poll-option-4').value.trim();
        
        const options = [option1, option2, option3, option4].filter(o => o);
        
        if (options.length < 2) {
          showToast('Debes agregar al menos 2 opciones', 'error');
          return;
        }
        
        if (state.allRecords.length >= 999) {
          showToast('L√≠mite de 999 registros alcanzado', 'error');
          return;
        }
        
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Creando...';
        
        const result = await dataSdk.create({
          poll_id: 'poll_' + Date.now(),
          poll_title: title,
          poll_options: JSON.stringify(options),
          poll_created_by: state.user.uid
        });
        
        if (result.isOk) {
          showToast('Encuesta creada', 'success');
          modal.remove();
        } else {
          showToast('Error al crear encuesta', 'error');
          btn.disabled = false;
          btn.textContent = 'Crear Encuesta';
        }
      });
    }
    
    // Render profile
    function renderProfile() {
      const app = document.getElementById('app');
      
      const userProfile = state.allRecords.find(r => r.user_profile === state.user?.uid && r.username);
      const username = userProfile?.username || state.user?.displayName || 'Usuario';
      const subname = userProfile?.subname || '';
      const email = userProfile?.email || state.user?.email || '';
      const avatarUrl = userProfile?.avatar_url || '';
      
      const userRatings = state.allRecords.filter(r => r.rating_series_id && r.user_profile === state.user?.uid);
      const userEpisodes = state.allRecords.filter(r => r.episode_series_id && r.watched && r.user_profile === state.user?.uid);
      
      app.innerHTML = `
        <div class="h-full w-full overflow-auto">
          <!-- Header -->
          <header class="sticky top-0 z-40 glassmorphism border-b border-gray-700">
            <div class="max-w-screen-xl mx-auto px-6 py-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <button id="back-btn" class="text-green-500 hover:text-green-400 transition">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                  </svg>
                </button>
                <h1 class="text-2xl md:text-3xl font-bold">Mi Perfil</h1>
              </div>
              
              ${!state.isGuest ? `
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                  Cerrar Sesi√≥n
                </button>
              ` : `
                <button id="login-from-guest-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded-lg ripple-effect transition">
                  Iniciar Sesi√≥n
                </button>
              `}
            </div>
          </header>
          
          <main class="max-w-screen-xl mx-auto px-6 py-8">
            <!-- Profile info -->
            <div class="bg-gray-800 rounded-2xl p-8 mb-8">
              <div class="flex flex-col md:flex-row items-center gap-6 mb-6">
                <button id="change-avatar-btn" class="w-20 h-20 rounded-full overflow-hidden border-4 border-green-500 hover:scale-110 transition ${avatarUrl ? '' : 'avatar-gradient'} ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}">
                  ${avatarUrl ? `<img src="${avatarUrl}" alt="Avatar" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-white font-bold text-2xl\\'>U</div>'">` : '<div class="w-full h-full flex items-center justify-center text-white font-bold text-2xl">U</div>'}
                </button>
                
                <div class="flex-1 text-center md:text-left w-full">
                  <div class="mb-2">
                    <input type="text" id="username-input" value="${username}" class="text-2xl font-bold bg-transparent border-b-2 border-transparent hover:border-green-500 focus:border-green-500 focus:outline-none transition px-2 w-full ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}" ${state.isGuest ? 'disabled' : ''}>
                  </div>
                  <div class="mb-2">
                    <div class="flex items-center gap-2">
                      <span class="text-gray-400">@</span>
                      <input type="text" id="subname-input" value="${subname}" placeholder="tu_nombre_usuario" class="text-base text-gray-400 bg-transparent border-b-2 border-transparent hover:border-green-500 focus:border-green-500 focus:outline-none transition px-2 flex-1 ${state.isGuest ? 'opacity-50 cursor-not-allowed' : ''}" ${state.isGuest ? 'disabled' : ''}>
                    </div>
                  </div>
                  ${!state.isGuest ? `<p class="text-sm text-gray-400">${email}</p>` : '<p class="text-sm text-gray-400">Modo Invitado</p>'}
                </div>
              </div>
              
              ${!state.isGuest ? `
                <div class="flex gap-4">
                  <button id="save-profile-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-2 rounded-lg ripple-effect transition">
                    Guardar Cambios
                  </button>
                </div>
              ` : ''}
            </div>
            
            <!-- Stats -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
              <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-bold mb-2">Series Calificadas</h3>
                <p class="text-4xl font-bold text-green-500">${userRatings.length}</p>
              </div>
              
              <div class="bg-gray-800 rounded-xl p-6">
                <h3 class="text-lg font-bold mb-2">Episodios Vistos</h3>
                <p class="text-4xl font-bold text-pink-500">${userEpisodes.length}</p>
              </div>
            </div>
            
            <!-- Mi Lista -->
            <div class="mb-8">
              <h2 class="text-2xl font-bold mb-6">Mi Lista</h2>
              ${(() => {
                const myListRecords = state.allRecords.filter(r => r.my_list_series_id && r.user_profile === state.user?.uid);
                
                if (myListRecords.length === 0) {
                  return '<div class="bg-gray-800 rounded-xl p-8 text-center text-gray-400">No has agregado series a tu lista aÔøΩÔøΩÔøΩÔøΩn</div>';
                }
                
                return `
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                    ${myListRecords.map(record => {
                      const series = SERIES_DATA.find(s => s.id === record.my_list_series_id);
                      if (!series) return '';
                      return createSeriesCard(series);
                    }).join('')}
                  </div>
                `;
              })()}
            </div>
            
            ${state.isGuest ? `
              <div class="bg-yellow-500/20 border border-yellow-500 rounded-xl p-6 text-center">
                <p class="text-yellow-500 font-semibold mb-4">Est√°s en modo invitado. Inicia sesi√≥n para guardar tu progreso y personalizar tu perfil.</p>
                <button id="invite-login-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold px-6 py-3 rounded-lg ripple-effect transition">
                  Crear Cuenta o Iniciar Sesi√≥n
                </button>
              </div>
            ` : ''}
          </main>
        </div>
      `;
      
      document.getElementById('back-btn').addEventListener('click', () => navigateTo('home'));
      
      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        if (!auth) return;
        
        await auth.signOut();
        state.user = null;
        state.isGuest = false;
        showToast('Sesi√≥n cerrada', 'success');
        navigateTo('login');
      });
      
      document.getElementById('login-from-guest-btn')?.addEventListener('click', () => {
        state.isGuest = false;
        navigateTo('login');
      });
      
      document.getElementById('invite-login-btn')?.addEventListener('click', () => {
        state.isGuest = false;
        navigateTo('login');
      });
      
      document.getElementById('change-avatar-btn')?.addEventListener('click', () => {
        if (state.isGuest) {
          showToast('Inicia sesi√≥n para cambiar avatar', 'info');
          return;
        }
        showAvatarSelector();
      });
      
      document.querySelectorAll('.series-card').forEach(card => {
        card.addEventListener('click', () => {
          const seriesId = card.dataset.seriesId;
          const series = SERIES_DATA.find(s => s.id === seriesId);
          if (series) navigateTo('series', series);
        });
      });
      
      document.getElementById('save-profile-btn')?.addEventListener('click', async () => {
        const newUsername = document.getElementById('username-input').value.trim();
        const newSubname = document.getElementById('subname-input').value.trim();
        
        if (!newUsername) {
          showToast('El nombre de usuario no puede estar vac√≠o', 'error');
          return;
        }
        
        const btn = document.getElementById('save-profile-btn');
        btn.disabled = true;
        btn.textContent = 'Guardando...';
        
        const existingProfile = state.allRecords.find(r => r.user_profile === state.user.uid && r.username);
        
        if (existingProfile) {
          existingProfile.username = newUsername;
          existingProfile.subname = newSubname;
          const result = await dataSdk.update(existingProfile);
          
          if (result.isOk) {
            showToast('Perfil actualizado', 'success');
          } else {
            showToast('Error al actualizar perfil', 'error');
          }
        } else {
          if (state.allRecords.length >= 999) {
            showToast('L√≠mite de 999 registros alcanzado', 'error');
            btn.disabled = false;
            btn.textContent = 'Guardar Cambios';
            return;
          }
          
          const result = await dataSdk.create({
            user_profile: state.user.uid,
            username: newUsername,
            subname: newSubname,
            avatar_series_id: '',
            avatar_character_id: '',
            avatar_url: '',
            email: state.user.email
          });
          
          if (result.isOk) {
            showToast('Perfil creado', 'success');
          } else {
            showToast('Error al crear perfil', 'error');
          }
        }
        
        btn.disabled = false;
        btn.textContent = 'Guardar Cambios';
      });
    }
    
    function showAvatarSelector() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-in';
      modal.innerHTML = `
        <div class="bg-gray-800 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-auto slide-up">
          <div class="sticky top-0 bg-gray-800 border-b border-gray-700 px-6 py-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Seleccionar Avatar</h3>
            <button class="close-modal text-gray-400 hover:text-white transition">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div class="p-6 space-y-8">
            ${AVATAR_LIBRARY.map(seriesGroup => `
              <div>
                <h4 class="text-lg font-bold mb-4">${seriesGroup.series}</h4>
                <div class="flex gap-4 overflow-x-auto pb-2">
                  ${seriesGroup.characters.map(char => `
                    <button class="avatar-option flex-shrink-0 w-20 h-20 rounded-full overflow-hidden hover:scale-110 transition border-4 border-transparent hover:border-green-500" data-series="${seriesGroup.series}" data-char-id="${char.id}" data-url="${char.url}">
                      <img src="${char.url}" alt="${char.name}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                    </button>
                  `).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      modal.querySelectorAll('.avatar-option').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!dataSdk || !db) {
            showToast('Base de datos no disponible', 'error');
            return;
          }
          
          const series = btn.dataset.series;
          const charId = btn.dataset.charId;
          const url = btn.dataset.url;
          
          btn.disabled = true;
          
          const existingProfile = state.allRecords.find(r => r.user_profile === state.user.uid && r.username);
          
          if (existingProfile) {
            existingProfile.avatar_series_id = series;
            existingProfile.avatar_character_id = charId;
            existingProfile.avatar_url = url;
            
            const result = await dataSdk.update(existingProfile);
            
            if (result.isOk) {
              showToast('Avatar actualizado', 'success');
              modal.remove();
            } else {
              showToast('Error al actualizar avatar', 'error');
              btn.disabled = false;
            }
          } else {
            if (state.allRecords.length >= 999) {
              showToast('L√≠mite de 999 registros alcanzado', 'error');
              btn.disabled = false;
              return;
            }
            
            const result = await dataSdk.create({
              user_profile: state.user.uid,
              username: state.user.displayName || 'Usuario',
              subname: '',
              avatar_series_id: series,
              avatar_character_id: charId,
              avatar_url: url,
              email: state.user.email
            });
            
            if (result.isOk) {
              showToast('Avatar actualizado', 'success');
              modal.remove();
            } else {
              showToast('Error al crear perfil', 'error');
              btn.disabled = false;
            }
          }
        });
      });
    }
    
    // Start app
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b83376b859d1a50',t:'MTc2NzQ1MDg2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
